# 上下文管理 - 精准沟通与高效协作的艺术

> 状态：已完成
> 分类：沟通技巧
> 更新时间：2025-01-19

## 概述

上下文管理是 Claude Code 使用的核心技能。良好的上下文管理能够：
- 提高 AI 理解需求的准确性
- 减少来回澄清的时间成本
- 确保输出结果符合预期
- 提升整体开发效率

## 详细指令的艺术

### 指令精确度对比

| ❌ 模糊指令 | ✅ 详细指令 | 🚀 最佳实践 |
|------------|------------|------------|
| "添加测试" | "为 UserService 的 login 方法添加测试，验证密码错误时抛出 AuthenticationError" | "为 UserService.login() 添加测试用例：<br/>1. 正确密码返回用户信息<br/>2. 错误密码抛出 AuthenticationError<br/>3. 不存在用户抛出 UserNotFoundError<br/>4. 密码为空抛出 ValidationError<br/>使用 Jest，mock UserRepository" |
| "修复 bug" | "修复 Issue #123：用户登出后仍然可以访问受保护页面" | "修复 Issue #123 权限验证问题：<br/>问题：用户点击登出后，JWT token 仍在本地存储<br/>期望：清除所有认证信息，重定向到登录页<br/>测试：访问 /dashboard 应跳转到 /login<br/>影响范围：auth middleware, logout handler" |
| "优化性能" | "优化 /api/users 接口，将响应时间从 2s 降低到 500ms 以内" | "优化 /api/users 接口性能：<br/>当前问题：N+1 查询，每个用户单独查询角色<br/>目标：响应时间 < 500ms，支持分页<br/>方案：使用 JOIN 查询，添加数据库索引<br/>验证：使用 k6 压测，100并发用户" |

### 构建详细指令的框架

#### SMART 指令原则

- **Specific（具体）**：明确要做什么
- **Measurable（可测量）**：有明确的成功标准
- **Achievable（可实现）**：在技术能力范围内
- **Relevant（相关）**：与项目目标一致
- **Time-bound（有时限）**：有明确的完成预期

#### 5W2H 指令模板

```bash
# 使用 5W2H 框架构建指令
"
What: 实现用户权限管理系统
Why: 当前系统缺乏细粒度权限控制，存在安全风险
Who: 管理员可以分配权限，普通用户只能查看自己的权限
When: 用户登录后、访问受保护资源时进行权限检查
Where: 在 API Gateway 层进行统一权限验证
How: 使用 RBAC 模型，支持角色继承和动态权限
How much: 支持 1000+ 并发用户，权限检查延迟 < 10ms
"
```

### 精准用词的重要性

#### 思考强度控制

根据 Claude Code 官方文档，不同的词汇触发不同强度的思考：

```bash
# 基础思考（快速响应）
"think 一下如何实现这个功能"

# 中等思考（平衡质量和速度）
"think more 关于这个架构的设计方案"

# 深度思考（高质量输出）
"think harder 这个技术选型的利弊分析"

# 超深度思考（最高质量）
"ultrathink 分布式系统的一致性策略"
```

#### 专业术语使用

```bash
# ❌ 模糊表达
"让这个接口更快一点"

# ✅ 专业术语
"优化这个 REST API 的响应时间：
1. 添加 Redis 缓存层（TTL 5分钟）
2. 使用数据库连接池（最大20连接）
3. 实现请求去重（防止重复查询）
4. 添加 CDN 缓存静态资源"
```

### 上下文层次管理

#### 会话级上下文

**保持专注**：

```bash
# 清除不相关上下文
/clear

# 聚焦特定模块
"接下来的对话中，请专注于用户认证模块（@src/auth/）的相关问题，
暂时忽略其他模块的细节。"

# 设定工作边界
"在这个会话中，我们只讨论前端实现，不涉及后端 API 的修改。"
```

#### 项目级上下文

**目录聚焦**：

```bash
# 切换到特定目录
cd src/components/auth && claude

# 显式指定工作范围
"请专注于 @src/auth/ 目录下的文件，分析用户认证的完整流程"

# 排除不相关内容
"分析代码时请忽略 test/ 和 docs/ 目录，专注于核心业务逻辑"
```

#### 任务级上下文

**检查清单方法**：

```bash
"创建一个修复 TypeScript 类型错误的检查清单：

## 类型错误修复清单
- [ ] 分析 tsc 输出的所有错误
- [ ] 按错误类型分组（missing types, wrong types, import errors）
- [ ] 优先修复高频错误（影响多个文件的）
- [ ] 逐个修复并验证
- [ ] 运行完整类型检查确认无错误
- [ ] 提交前运行构建测试

请逐项完成这个清单。"
```

## 多种数据输入方式

### 1. 直接文本输入

```bash
# 复制粘贴代码片段
"请分析以下代码的性能问题：

```javascript
function processUsers(users) {
  return users.map(user => {
    const profile = getUserProfile(user.id);  // 同步数据库查询
    const permissions = getUserPermissions(user.id);  // 同步数据库查询
    return { ...user, profile, permissions };
  });
}
```"
```

### 2. 管道输入

```bash
# 错误日志分析
cat error.log | claude "分析这些错误日志，找出根本原因并提供修复建议"

# Git 差异分析
git diff HEAD~1 | claude "审查这些代码变更，检查是否有潜在问题"

# 测试结果分析
npm test 2>&1 | claude "分析测试失败原因并提供修复方案"
```

### 3. 文件路径引用

```bash
# 单文件分析
"请读取 @src/utils/database.ts 并分析连接池配置是否合理"

# 多文件对比
"对比 @src/models/User.ts 和 @src/models/Admin.ts，
找出公共逻辑并建议如何重构"

# 目录级分析
"分析 @src/components/ 目录下的所有组件，
检查是否遵循了统一的设计模式"
```

### 4. URL 资源获取

```bash
# API 文档分析
"请分析 https://api.github.com/users/octocat 的响应结构，
设计对应的 TypeScript 接口定义"

# 在线资源集成
"参考 https://nextjs.org/docs/authentication 的最佳实践，
优化我们现有的认证系统"

# 注意：确保网络连接和 VPN 配置正确
```

### 5. MCP 资源引用

```bash
# GitHub 集成
"查看当前项目的 Issues：@github:repos/owner/repo/issues"

# 数据库查询
"获取用户统计信息：@postgres:SELECT COUNT(*) FROM users WHERE created_at > '2024-01-01'"

# 文档搜索
"搜索相关文档：@confluence:search?q=authentication"
```

## 多媒体上下文管理

### 图片输入的三种方式

Claude Code 支持图片输入，这在前端开发和 UI 调试中特别有用：

#### 1. 拖拽输入

**操作步骤**：
1. 找到需要分析的图片文件
2. 直接拖拽到 Claude Code 窗口中
3. 图片会自动上传并显示在对话中

**适用场景**：
- 设计稿对比
- 错误截图分析
- UI 布局问题

#### 2. 剪贴板粘贴

**操作步骤**：
1. 截取屏幕或复制图片（Cmd+C / Ctrl+C）
2. 在 Claude Code 中使用 `Ctrl + V` 粘贴（注意不是 `Cmd + V`）
3. 图片会显示在对话中

**适用场景**：
- 快速截图分析
- 浏览器开发者工具截图
- 错误界面分析

#### 3. 文件路径引用

```bash
# 直接提供文件路径
"根据截图结果：/path/to/screenshot.png 
调整 CSS 样式，使实际效果匹配设计稿"

# 结合自动化测试
"使用 Puppeteer 截图对比：
1. 访问 localhost:3000/login
2. 截图保存到 screenshots/current.png  
3. 与 designs/login-expected.png 对比
4. 调整样式直到视觉差异 < 5%"
```

### 图片分析最佳实践

#### UI 对比分析

```bash
"对比这两张图片：
- 设计稿：design.png
- 当前实现：current.png

请分析差异并提供 CSS 修复方案：
1. 颜色差异（提供具体的 hex 值）
2. 间距问题（提供具体的 px/rem 值）
3. 字体大小和样式
4. 布局对齐问题

修复后请重新截图验证效果。"
```

#### 错误分析

```bash
"分析这个错误截图：error.png

请帮我：
1. 识别错误类型和位置
2. 分析可能的根本原因
3. 提供调试步骤
4. 给出修复建议
5. 如果需要，提供预防措施"
```

#### 响应式设计验证

```bash
"这是三个不同屏幕尺寸的截图：
- desktop.png (1920x1080)
- tablet.png (768x1024)  
- mobile.png (375x667)

请分析响应式设计问题：
1. 布局是否在所有尺寸下都正常
2. 文字是否过小或过大
3. 按钮和交互元素是否容易点击
4. 图片是否适当缩放

提供媒体查询优化建议。"
```

## 高级上下文管理技巧

### 1. 上下文分层策略

```bash
# Level 1: 全局上下文（项目级）
"项目背景：我们正在开发一个企业级的用户管理系统，
使用 Next.js + TypeScript + Prisma 技术栈"

# Level 2: 模块上下文（功能级）  
"当前模块：用户认证系统，包括注册、登录、权限验证"

# Level 3: 任务上下文（具体任务）
"当前任务：修复登录接口的性能问题，目标响应时间 < 200ms"

# Level 4: 技术上下文（实现细节）
"具体问题：数据库查询存在 N+1 问题，需要优化 JOIN 查询"
```

### 2. 上下文切换管理

```bash
# 保存当前上下文
"请记住当前我们正在讨论用户认证模块的性能优化问题。
现在我要暂时切换到处理一个紧急的前端 bug。"

# 恢复之前的上下文
"让我们回到之前讨论的用户认证性能优化问题。
我们刚才分析了 N+1 查询问题，请继续提供解决方案。"
```

### 3. 渐进式上下文构建

```bash
# 第一轮：基础理解
"请先理解项目的整体架构"

# 第二轮：深入分析
"基于刚才的理解，现在分析用户认证模块的设计"

# 第三轮：具体实现
"现在让我们实现 JWT token 刷新机制"

# 第四轮：优化完善
"最后，让我们优化异常处理和错误日志记录"
```

### 4. 上下文验证机制

```bash
# 定期确认理解
"在继续之前，请确认你对当前需求的理解：
1. 要实现什么功能？
2. 技术约束是什么？
3. 成功标准如何定义？
4. 有哪些风险需要考虑？"

# 关键节点总结
"请总结一下我们到目前为止讨论的要点：
- 已确定的技术方案
- 需要实现的功能列表
- 识别的技术风险
- 下一步行动计划"
```

## 上下文最佳实践

### DO's（推荐做法）

✅ **使用具体的业务术语**
```bash
"实现订单状态流转：待支付 → 已支付 → 已发货 → 已完成"
而不是："处理订单状态"
```

✅ **提供明确的验收标准**
```bash
"响应时间必须 < 200ms，支持 1000 并发用户，错误率 < 0.1%"
而不是："性能要好"
```

✅ **包含错误处理要求**
```bash
"当支付失败时，回滚库存，记录错误日志，向用户显示友好错误信息"
而不是："处理支付失败"
```

### DON'Ts（避免的做法）

❌ **避免模糊的形容词**
```bash
不要说："让界面更好看一点"
应该说："调整按钮间距为 16px，使用主品牌色 #007bff"
```

❌ **避免假设 AI 知道项目细节**
```bash
不要说："按照我们的规范实现"
应该说："按照项目 style-guide.md 中定义的组件规范实现"
```

❌ **避免一次性提供过多信息**
```bash
不要把整个需求文档一次性粘贴
应该逐步引导，先概述再深入细节
```

### 上下文质量检查

```bash
# 自检清单
"在提交这个需求前，请检查：
- [ ] 需求描述是否具体明确？
- [ ] 技术约束是否明确说明？
- [ ] 成功标准是否可测量？
- [ ] 是否包含错误处理要求？
- [ ] 是否考虑了边界情况？
- [ ] 是否提供了必要的上下文信息？"
```

---

*良好的上下文管理是人机协作成功的关键。通过精确的表达、结构化的信息组织和多元化的输入方式，我们可以最大化 Claude Code 的能力发挥。*