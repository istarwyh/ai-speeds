
> 状态：已完成
> 分类：沟通技巧


## 概述

上下文管理是 Claude Code 使用的核心技能。良好的上下文管理能够：
- 提高 AI 理解需求的准确性
- 减少来回澄清的时间成本
- 确保输出结果符合预期
- 提升整体开发效率

## 详细指令的艺术

### 指令精确度对比

| ❌ 模糊指令 | ✅ 详细指令 | 🚀 最佳实践 |
|------------|------------|------------|
| "添加测试" | "为 UserService 的 login 方法添加测试，验证密码错误时抛出 AuthenticationError" | "为 UserService.login() 添加测试用例：<br/>1. 正确密码返回用户信息<br/>2. 错误密码抛出 AuthenticationError<br/>3. 不存在用户抛出 UserNotFoundError<br/>4. 密码为空抛出 ValidationError<br/>使用 Jest，mock UserRepository" |
| "修复 bug" | "修复 Issue #123：用户登出后仍然可以访问受保护页面" | "修复 Issue #123 权限验证问题：<br/>问题：用户点击登出后，JWT token 仍在本地存储<br/>期望：清除所有认证信息，重定向到登录页<br/>测试：访问 /dashboard 应跳转到 /login<br/>影响范围：auth middleware, logout handler" |
| "优化性能" | "优化 /api/users 接口，将响应时间从 2s 降低到 500ms 以内" | "优化 /api/users 接口性能：<br/>当前问题：N+1 查询，每个用户单独查询角色<br/>目标：响应时间 < 500ms，支持分页<br/>方案：使用 JOIN 查询，添加数据库索引<br/>验证：使用 k6 压测，100并发用户" |

### 构建详细指令的框架

#### SMART 指令原则

- **Specific（具体）**：明确要做什么
- **Measurable（可测量）**：有明确的成功标准
- **Achievable（可实现）**：在技术能力范围内
- **Relevant（相关）**：与项目目标一致
- **Time-bound（有时限）**：有明确的完成预期

#### 5W2H 指令模板

\`\`\`bash
# 使用 5W2H 框架构建指令
"
What: 实现用户权限管理系统
Why: 当前系统缺乏细粒度权限控制，存在安全风险
Who: 管理员可以分配权限，普通用户只能查看自己的权限
When: 用户登录后、访问受保护资源时进行权限检查
Where: 在 API Gateway 层进行统一权限验证
How: 使用 RBAC 模型，支持角色继承和动态权限
How much: 支持 1000+ 并发用户，权限检查延迟 < 10ms
"
\`\`\

### 精准用词的重要性

#### 动作词汇精确度

| 模糊词汇 | 精确词汇 | 效果差异 |
|----------|----------|----------|
| "处理" | "验证、转换、存储" | 明确具体操作 |
| "优化" | "缓存、索引、异步" | 指明具体优化方式 |
| "修复" | "捕获异常、添加验证、更新逻辑" | 明确修复方法 |
| "集成" | "调用 API、解析响应、存储数据" | 具体集成步骤 |

#### 技术词汇标准化

\`\`\`bash
# 推荐使用的精确技术词汇
"使用 bcrypt 对密码进行哈希加密"  # 而不是 "加密密码"
"实现 JWT token 验证中间件"      # 而不是 "添加认证"
"使用 Redis 缓存用户会话数据"    # 而不是 "优化登录"
"添加数据库索引到 user_email"   # 而不是 "提高查询速度"
\`\`\

## 上下文构建策略

### 分层上下文管理

#### 1. 项目级上下文（Project Context）

\`\`\`markdown
# 项目背景
- 项目名称：电商平台 API
- 技术栈：Node.js + Express + PostgreSQL + Redis
- 架构模式：微服务 + RESTful API
- 部署环境：Docker + Kubernetes + AWS

# 关键约束
- 响应时间要求：< 200ms
- 并发用户数：10,000+
- 数据一致性：强一致性
- 安全标准：OWASP Top 10 合规
\`\`\

#### 2. 模块级上下文（Module Context）

\`\`\`markdown
# 用户认证模块
- 负责功能：用户注册、登录、权限验证
- 依赖服务：用户服务、邮件服务、SMS 服务
- 数据存储：用户表、角色表、权限表
- 外部集成：OAuth2 (Google, GitHub)、2FA (TOTP)
\`\`\

#### 3. 任务级上下文（Task Context）

\`\`\`markdown
# 当前任务：实现用户登录接口
- 输入：email, password
- 输出：JWT token, 用户信息
- 验证：邮箱格式、密码强度、账户状态
- 异常：凭据错误、账户锁定、服务不可用
\`\`\

### 上下文传递技巧

#### 引用式上下文

\`\`\`bash
# 引用之前的对话
"根据我们之前讨论的用户认证架构（第15条消息），现在实现密码重置功能"

# 引用文档内容
"按照 docs/api-design.md 中定义的错误响应格式，为登录接口添加错误处理"

# 引用代码片段
"参考 UserService.create() 方法的实现模式，为 UserService.updateProfile() 添加参数验证"
\`\`\

#### 累积式上下文

\`\`\`bash
# 第一步：建立基础上下文
"我们正在开发一个电商平台的用户系统，使用 Node.js + PostgreSQL"

# 第二步：添加具体需求
"需要实现用户注册功能，支持邮箱验证和手机号验证两种方式"

# 第三步：补充技术细节
"使用 bcrypt 加密密码，JWT 作为认证 token，Redis 存储会话"

# 第四步：明确验收标准
"注册成功后发送欢迎邮件，用户需要点击链接激活账户才能登录"
\`\`\

## 常见上下文管理陷阱

### 1. 信息过载

❌ **错误示例**：
\`\`\`bash
"我有一个电商网站，使用React、Node.js、PostgreSQL、Redis、Docker、Kubernetes、AWS、Stripe、SendGrid、Twilio，用户可以注册、登录、购买商品、支付、收藏、评价、分享，管理员可以管理商品、订单、用户、统计，现在我想添加一个推荐系统..."
\`\`\

✅ **正确做法**：
\`\`\`bash
"项目：电商平台 API
当前任务：实现商品推荐功能
技术栈：Node.js + PostgreSQL
相关模块：用户行为跟踪、商品目录
输入数据：用户浏览历史、购买记录
输出格式：推荐商品列表（ID + 推荐分数）"
\`\`\

### 2. 上下文丢失

❌ **错误示例**：
\`\`\`bash
# 第一条消息
"帮我实现用户注册功能"

# 第十条消息（中间省略其他对话）
"现在添加邮箱验证"  # 缺少与注册功能的关联
\`\`\

✅ **正确做法**：
\`\`\`bash
"为之前实现的用户注册功能添加邮箱验证：
- 注册时生成验证 token
- 发送验证邮件到用户邮箱
- 用户点击链接后激活账户
- 未验证用户无法登录"
\`\`\

### 3. 假设依赖

❌ **错误示例**：
\`\`\`bash
"优化这个查询的性能"  # 假设 AI 知道是哪个查询
\`\`\

✅ **正确做法**：
\`\`\`bash
"优化 UserService.getUsersWithOrders() 方法中的数据库查询性能：
当前问题：N+1 查询，每个用户单独查询订单
目标：单次查询获取用户和订单数据
影响：用户列表页面加载时间从 2s 降到 500ms 以内"
\`\`\

## 高级上下文技巧

### 1. 角色扮演上下文

\`\`\`bash
"请以资深 Node.js 架构师的身份，review 这段认证中间件代码：
- 关注安全漏洞和性能问题
- 提供具体的改进建议
- 考虑高并发场景下的表现
- 遵循 OWASP 安全最佳实践"
\`\`\

### 2. 场景模拟上下文

\`\`\`bash
"模拟以下场景并提供解决方案：
场景：电商促销活动期间，用户登录量激增 10 倍
现状：登录接口响应时间从 100ms 增加到 3s
要求：在不增加服务器成本的前提下优化性能
约束：不能改变现有的 JWT 认证机制"
\`\`\

### 3. 对比分析上下文

\`\`\`bash
"比较以下三种用户认证方案的优缺点：
方案A：传统 Session + Cookie
方案B：JWT Token
方案C：OAuth2 + JWT

评估维度：
- 安全性（XSS、CSRF 防护）
- 性能（服务器负载、网络开销）
- 可扩展性（分布式、微服务友好）
- 开发复杂度（实现难度、维护成本）

项目背景：电商平台，10k+ 并发用户"
\`\`\

## 最佳实践总结

### Do's（推荐做法）

1. **分层构建上下文**：项目级 → 模块级 → 任务级
2. **使用精确词汇**：技术术语标准化，避免歧义
3. **提供完整信息**：输入、输出、约束、验收标准
4. **引用历史上下文**：建立连贯的对话历史
5. **定期重新确认**：确保 AI 理解正确

### Don'ts（避免做法）

1. **信息过载**：一次性提供过多无关信息
2. **假设依赖**：假设 AI 知道隐含的上下文
3. **模糊表达**：使用含糊不清的词汇和描述
4. **忽略约束**：不提供技术和业务约束条件
5. **缺乏验证**：不确认 AI 的理解是否正确

---
