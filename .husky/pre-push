set -euo pipefail

# Project root (absolute)
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)

# Pre-push scoped typecheck only
echo "Running pre-push checks (scoped typecheck)..."

# Determine upstream reference (if any)
UPSTREAM_REF=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")
if [ -n "$UPSTREAM_REF" ]; then
  BASE_REF=$(git merge-base HEAD "$UPSTREAM_REF")
else
  # Fallback to previous commit if no upstream
  BASE_REF=$(git rev-parse HEAD~1)
fi

# Changed files in the push range
CHANGED_FILES=$(git diff --name-only "$BASE_REF"...HEAD || true)

# Consider TS/TSX changes under safer code paths only
# Exclude legacy client runtime tree that may have ambient types conflicts
FILTERED_TS_FILES=$(echo "$CHANGED_FILES" | grep -E '^(src/app|src/components-next|scripts|modules)/.*\.(ts|tsx)$' || true)

if [ -z "$FILTERED_TS_FILES" ]; then
  echo "No TypeScript changes in code paths. Skipping typecheck."
  exit 0
fi

echo "Running TypeScript checks on changed files..."

# Build a list of existing files (skip deletions)
FILES=""
for f in $FILTERED_TS_FILES; do
  if [ -f "$f" ]; then
    FILES="$FILES $f"
  fi
done

if [ -z "$FILES" ]; then
  echo "No existing TS files to check (deletions only). Skipping."
  exit 0
fi

# If too many files changed, fall back to full project typecheck
COUNT=$(printf "%s" "$FILES" | wc -w | tr -d ' ')
if [ "$COUNT" -gt 100 ]; then
  echo "$COUNT files changed. Running full typecheck..."
  npm run typecheck
else
  # Create a temporary tsconfig at repo root to ensure relative resolution works
  TMP_TSCONFIG="$REPO_ROOT/.git/tsconfig.changed.json"

  FILES_JSON=""
  for f in $FILES; do
    ABS_F="$REPO_ROOT/$f"
    if [ -f "$ABS_F" ]; then
      FILES_JSON="$FILES_JSON\"$ABS_F\"," 
    fi
  done
  # Trim trailing comma
  FILES_JSON=${FILES_JSON%,}

  cat > "$TMP_TSCONFIG" <<EOF
{
  "extends": "$REPO_ROOT/tsconfig.json",
  "include": [],
  "files": [ $FILES_JSON ]
}
EOF

  echo "Using temporary tsconfig: $TMP_TSCONFIG"
  npx -y tsc --noEmit -p "$TMP_TSCONFIG" --pretty false
fi

echo "Pre-push typecheck completed."