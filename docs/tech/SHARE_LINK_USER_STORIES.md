# 分享链接用户故事（完整版）

## 核心价值主张

- 作为访客，我能一键分享当前卡片/文章，对方打开链接即定位，沟通清晰、省时高效。
- 作为移动端用户，我能直接复制图片或扫码跳转，适配社媒传播与跨设备延续。
- 作为作者/开发者，分享链路稳定、可观测、可扩展，降低维护与迭代成本。

## 链接规范（深链）

- 格式：`{origin}/home?module=bestPractices&view=overview&cardId={id}`
- 语义：`module` 定位模块；`view` 定位视图；`cardId` 精准定位卡片
- 兼容：参数缺失/未知时降级到模块首页，不阻断访问

## 用户故事（精简验收）

- 访客：点击卡片内“分享”，在预览弹窗选择“复制图片/下载图片/复制链接/取消”。
  - 验收：弹窗可见；四个动作均可用；ESC/遮罩关闭；焦点回到触发按钮
- 接收者：打开分享链接后直接定位到对应卡片或文章位置。
  - 验收：解析深链参数并滚动/高亮定位；文章视图标题与锚点匹配
- 移动端：扫描海报二维码跳转到相同深链，继续浏览或二次分享。
  - 验收：二维码可解析；网络受限时显示占位并可复制链接
- 作者：分享图片/链接保持品牌与版式统一，外链封面可安全绘制。
  - 验收：海报含“aispeeds.me”水印；封面经 `/img-proxy` 绘制；失败不报错
- 开发者：具备性能预热与故障降级，体验稳定。
  - 验收：视口预热生效；二维码/剪贴板失败时自动降级（下载/占位/复制链接）

## 用户动线图

- 桌面端分享
```text
卡片点击分享
  -> 预览弹窗 (已预热: 封面/二维码)
    -> 复制链接 | 复制图片 | 下载图片 | 取消
      -> 外部平台/IM
        -> 接收者点击链接
          -> 打开站点 + 解析深链
            -> 定位到目标卡片/文章
```

- 跨设备扫码
```text
桌面端生成海报 (含二维码)
  -> 手机扫码
    -> H5 打开 + 解析深链
      -> 定位卡片/文章
        -> 二次分享 (复制图片/复制链接)
```

- 异常与降级
```text
二维码生成失败 -> 展示占位符 + 提示复制链接
外部封面跨域/超时 -> 省略封面绘制，保留文本主体
剪贴板受限 (Safari/权限) -> 自动下载 PNG
预热失败/超时 -> 正常渲染，不阻断分享
```

## 非功能性与指标

- 性能：视口预热（封面 `/img-proxy`、二维码）；字体就绪后绘制；极端比例封面智能适配
- 可用性：弹窗支持 ESC/遮罩关闭；焦点归位；按钮具 `aria-label`；占位符含操作提示
- 安全：代理白名单 `IMAGE_PROXY_WHITELIST`（开发可为 `*`，生产收敛）；`IMAGE_PROXY_CACHE_TTL`；剪贴板仅在用户手势触发
- 观测：预览 TTI、复制/下载成功率、深链打开成功率、定位准确率、二维码解析率

## 与实现对齐

- 预览与画布生成：`src/client/shared/services/ShareService.ts`
  - 深链构建、二维码渲染/占位、封面代理绘制、动态比例智能适配
- 事件与预热：`src/client/shared/handlers/BaseArticleEventHandler.ts`
  - 点击拦截防导航、`IntersectionObserver` 视口预热

## 验收清单（摘要）

- 打开分享链接后精准定位目标卡片/文章
- 四个动作（复制链接/复制图片/下载/取消）可用并有降级策略
- 二维码解析成功；失败有占位与备选动作
- 外部封面在允许主机下可绘制；失败不影响分享
- 视口预热对预览 TTI 有正向影响（可测）
