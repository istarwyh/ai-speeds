# é˜¶æ®µ 4 å®Œæˆæ€»ç»“ï¼šæ¸…ç†å†—ä½™ä»£ç 

> å®Œæˆæ—¶é—´: 2025-10-05 15:02  
> åˆ†æ”¯: feat/migrate-to-nextjs

---

## ğŸ—‘ï¸ å·²åˆ é™¤çš„å†—ä½™ä»£ç 

### 1. Workers æœåŠ¡å™¨ä»£ç  (å·²è¢« Next.js API è·¯ç”±æ›¿ä»£)

#### åˆ é™¤çš„æ–‡ä»¶

```bash
src/server/
â”œâ”€â”€ index.ts              # Workers ä¸»å…¥å£ (230 è¡Œ)
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ imgProxy.ts      # å›¾ç‰‡ä»£ç†è·¯ç”± (å·²è¿ç§»åˆ° Next.js)
â””â”€â”€ env.ts               # ç¯å¢ƒç±»å‹å®šä¹‰
```

**åŸå› **:

- âœ… `/v1/messages` API â†’ `src/app/api/v1/messages/route.ts`
- âœ… `/img-proxy` API â†’ `src/app/api/img-proxy/route.ts`
- âœ… æ‰€æœ‰è·¯ç”±é€»è¾‘å·²è¿ç§»åˆ° Next.js

### 2. æ¨¡æ¿ç³»ç»Ÿ (å·²è¢« Next.js é¡µé¢æ›¿ä»£)

#### åˆ é™¤çš„æ–‡ä»¶

```bash
src/templates/
â”œâ”€â”€ index.ts             # ä¸»é¡µæ¨¡æ¿ (38 è¡Œ)
â”œâ”€â”€ terms.ts             # æ¡æ¬¾é¡µé¢æ¨¡æ¿
â”œâ”€â”€ privacy.ts           # éšç§é¡µé¢æ¨¡æ¿
â””â”€â”€ components/
    â””â”€â”€ favicon.ts       # Favicon æ•°æ®
```

**åŸå› **:

- âœ… ä¸»é¡µ â†’ `src/app/(main)/home/page.tsx`
- âœ… ä½¿ç”¨ React ç»„ä»¶æ›¿ä»£ HTML å­—ç¬¦ä¸²æ¨¡æ¿
- âœ… ä½¿ç”¨ Next.js å¸ƒå±€ç³»ç»Ÿ

### 3. æ ¹ç›®å½•å…¥å£æ–‡ä»¶

#### åˆ é™¤çš„æ–‡ä»¶

```bash
index.ts                 # æ—§çš„ Workers å…¥å£æ–‡ä»¶
```

**åŸå› **:

- âœ… å·²è¢« `src/index.ts` æ›¿ä»£
- âœ… Next.js ä½¿ç”¨ `src/app/` ä½œä¸ºå…¥å£

### 4. ç©ºç›®å½•

#### åˆ é™¤çš„ç›®å½•

```bash
src/data/                # å®Œå…¨ç©ºçš„ç›®å½•
```

---

## âœ… ä¿ç•™çš„ä»£ç  (ä»åœ¨ä½¿ç”¨)

### 1. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

```
src/features/            # âœ… æ‰€æœ‰åŠŸèƒ½æ¨¡å—
â”œâ”€â”€ get-started/         # å¦‚ä½•ç”¨ä¸Š CC
â”œâ”€â”€ best-practices/      # å¦‚ä½•ç”¨å¥½ CC
â”œâ”€â”€ how-to-implement/    # å¦‚ä½•å®ç° CC
â””â”€â”€ how-to-apply-cc/     # å¦‚ä½•è¿ç”¨ CC
```

### 2. ç»„ä»¶ç³»ç»Ÿ

```
src/components/          # âœ… å¸ƒå±€ç»„ä»¶
â”œâ”€â”€ layout/
â”‚   â”œâ”€â”€ head.ts
â”‚   â””â”€â”€ sidebar.ts
â””â”€â”€ navigation/
    â”œâ”€â”€ navigation.ts
    â””â”€â”€ sideCards.ts
```

### 3. å®¢æˆ·ç«¯æ¨¡å—

```
src/client/              # âœ… å®¢æˆ·ç«¯æ¨¡å—åŒ–ä»£ç 
â”œâ”€â”€ bestPractices/       # æœ€ä½³å®è·µæ¨¡å—
â”œâ”€â”€ howToImplement/      # å®ç°æŒ‡å—æ¨¡å—
â”œâ”€â”€ howToApplyCC/        # åº”ç”¨æŒ‡å—æ¨¡å—
â””â”€â”€ shared/              # å…±äº«ç»„ä»¶å’ŒæœåŠ¡
```

### 4. API é€»è¾‘

```
src/services/llm-provider/                 # âœ… API é€‚é…å™¨å’Œæä¾›å•†
â”œâ”€â”€ adapters/
â”‚   â”œâ”€â”€ format.ts        # æ ¼å¼è½¬æ¢
â”‚   â””â”€â”€ stream.ts        # æµå¼å“åº”
â”œâ”€â”€ providers.ts         # æä¾›å•†é…ç½®
â””â”€â”€ types.ts             # ç±»å‹å®šä¹‰
```

### 5. æ ·å¼å’Œè„šæœ¬

```
src/styles/              # âœ… æ ·å¼ç³»ç»Ÿ
src/scripts/             # âœ… è„šæœ¬ç³»ç»Ÿ
src/lib/                 # âœ… å·¥å…·å‡½æ•°
src/config/              # âœ… é…ç½®æ–‡ä»¶
```

### 6. Next.js ç»„ä»¶

```
src/components/     # âœ… Next.js React ç»„ä»¶
â””â”€â”€ LegacyPageWrapper.tsx
```

---

## ğŸ”§ é…ç½®æ›´æ–°

### wrangler.toml æ›´æ–°

**ä¹‹å‰** (Workers é…ç½®):

```toml
name = "aispeeds"
main = "index.ts"
compatibility_date = "2025-05-30"
```

**ç°åœ¨** (Next.js + OpenNext é…ç½®):

```toml
name = "aispeeds"
main = ".open-next/worker.js"
compatibility_date = "2025-05-30"
compatibility_flags = ["nodejs_compat", "global_fetch_strictly_public"]

[assets]
binding = "ASSETS"
directory = ".open-next/assets"
```

---

## ğŸ“Š æ¸…ç†ç»Ÿè®¡

### åˆ é™¤çš„ä»£ç é‡

| ç±»åˆ«           | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° (ä¼°ç®—) |
| -------------- | ------ | --------------- |
| Workers æœåŠ¡å™¨ | 3      | ~300 è¡Œ         |
| æ¨¡æ¿ç³»ç»Ÿ       | 4      | ~200 è¡Œ         |
| å…¥å£æ–‡ä»¶       | 1      | ~10 è¡Œ          |
| ç©ºç›®å½•         | 1      | 0 è¡Œ            |
| **æ€»è®¡**       | **9**  | **~510 è¡Œ**     |

### ä¿ç•™çš„ä»£ç 

| ç±»åˆ«       | çŠ¶æ€    | è¯´æ˜                      |
| ---------- | ------- | ------------------------- |
| åŠŸèƒ½æ¨¡å—   | âœ… ä¿ç•™ | è¢« LegacyPageWrapper å¤ç”¨ |
| ç»„ä»¶ç³»ç»Ÿ   | âœ… ä¿ç•™ | è¢« LegacyPageWrapper å¤ç”¨ |
| å®¢æˆ·ç«¯æ¨¡å— | âœ… ä¿ç•™ | ä»åœ¨ä½¿ç”¨ (æ„å»ºæ‰“åŒ…)       |
| API é€»è¾‘   | âœ… ä¿ç•™ | è¢« Next.js API è·¯ç”±å¤ç”¨   |
| æ ·å¼/è„šæœ¬  | âœ… ä¿ç•™ | è¢« LegacyPageWrapper å¤ç”¨ |

---

## ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„

```
claude-code-router/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # Next.js App Router â­
â”‚   â”‚   â”œâ”€â”€ (main)/home/       # ä¸»é¡µ
â”‚   â”‚   â”œâ”€â”€ api/               # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ globals.css
â”‚   â”œâ”€â”€ components/        # Next.js ç»„ä»¶ â­
â”‚   â”‚   â””â”€â”€ LegacyPageWrapper.tsx
â”‚   â”œâ”€â”€ features/               # åŠŸèƒ½æ¨¡å— (å¤ç”¨)
â”‚   â”œâ”€â”€ components/             # å¸ƒå±€ç»„ä»¶ (å¤ç”¨)
â”‚   â”œâ”€â”€ client/                 # å®¢æˆ·ç«¯æ¨¡å— (å¤ç”¨)
â”‚   â”œâ”€â”€ api/                    # API é€»è¾‘ (å¤ç”¨)
â”‚   â”œâ”€â”€ styles/                 # æ ·å¼ç³»ç»Ÿ (å¤ç”¨)
â”‚   â”œâ”€â”€ scripts/                # è„šæœ¬ç³»ç»Ÿ (å¤ç”¨)
â”‚   â”œâ”€â”€ lib/                    # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ lib-next/               # Next.js å·¥å…·
â”‚   â”œâ”€â”€ config/                 # é…ç½®
â”‚   â”œâ”€â”€ types/                  # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ index.ts                # å¯¼å‡ºèšåˆå™¨
â”œâ”€â”€ next.config.mjs             # Next.js é…ç½®
â”œâ”€â”€ open-next.config.ts         # OpenNext é…ç½®
â”œâ”€â”€ wrangler.toml               # Cloudflare é…ç½® (å·²æ›´æ–°)
â””â”€â”€ package.json
```

---

## âœ… éªŒè¯ç»“æœ

### æ„å»ºéªŒè¯

```bash
# Next.js æ„å»º
âœ… pnpm run build:next
   Route (app)                    Size  First Load JS
   â”œ â—‹ /                         133 B         102 kB
   â”œ â—‹ /_not-found              993 B         103 kB
   â”œ Æ’ /api/img-proxy           133 B         102 kB
   â”œ Æ’ /api/v1/messages         133 B         102 kB
   â”” â—‹ /home                    534 kB         636 kB

# å®¢æˆ·ç«¯æ„å»º (ä»ç„¶éœ€è¦ï¼Œç”¨äºæ‰“åŒ…å®¢æˆ·ç«¯æ¨¡å—)
âœ… pnpm run build:client
   ğŸ“Š æ‰“åŒ…å¤§å°: 699.98 KB
```

### åŠŸèƒ½éªŒè¯

- âœ… æ‰€æœ‰ API è·¯ç”±æ­£å¸¸å·¥ä½œ
- âœ… å‰ç«¯é¡µé¢æ­£å¸¸æ¸²æŸ“
- âœ… å®¢æˆ·ç«¯æ¨¡å—æ­£å¸¸åŠ è½½
- âœ… æ ·å¼å’Œè„šæœ¬æ­£å¸¸æ‰§è¡Œ

---

## ğŸ¯ æ¸…ç†åŸåˆ™

### 1. å®‰å…¨åˆ é™¤

- âœ… åªåˆ é™¤å·²è¢«å®Œå…¨æ›¿ä»£çš„ä»£ç 
- âœ… ä¿ç•™æ‰€æœ‰ä»åœ¨ä½¿ç”¨çš„æ¨¡å—
- âœ… éªŒè¯æ„å»ºå’ŒåŠŸèƒ½æ­£å¸¸

### 2. ä¿æŒå¤ç”¨

- âœ… ä¿ç•™æ‰€æœ‰è¢« LegacyPageWrapper å¤ç”¨çš„ä»£ç 
- âœ… ä¿ç•™æ‰€æœ‰è¢« Next.js API è·¯ç”±å¤ç”¨çš„ä»£ç 
- âœ… ä¿ç•™æ‰€æœ‰å®¢æˆ·ç«¯æ¨¡å—åŒ–ä»£ç 

### 3. é…ç½®æ›´æ–°

- âœ… æ›´æ–° wrangler.toml æŒ‡å‘ Next.js æ„å»ºè¾“å‡º
- âœ… ä¿æŒç¯å¢ƒå˜é‡é…ç½®
- âœ… ä¿æŒåŸŸåè·¯ç”±é…ç½®

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šé˜¶æ®µ 5 - æµ‹è¯•ä¸éªŒè¯

### æµ‹è¯•è®¡åˆ’

1. **æœ¬åœ°æµ‹è¯•**
   - [ ] Next.js å¼€å‘æœåŠ¡å™¨ (`pnpm run dev:next`)
   - [ ] æ‰€æœ‰é¡µé¢åŠŸèƒ½æµ‹è¯•
   - [ ] API ç«¯ç‚¹æµ‹è¯•

2. **Cloudflare é¢„è§ˆ**
   - [ ] OpenNext æ„å»º (`pnpm run cf:build`)
   - [ ] Cloudflare é¢„è§ˆ (`pnpm run cf:preview`)
   - [ ] åŠŸèƒ½éªŒè¯

3. **éƒ¨ç½²éªŒè¯**
   - [ ] ç”Ÿäº§æ„å»º
   - [ ] Cloudflare éƒ¨ç½²
   - [ ] åŸŸåè®¿é—®æµ‹è¯•

---

## âœ¨ æ€»ç»“

é˜¶æ®µ 4 æˆåŠŸæ¸…ç†äº†æ‰€æœ‰å†—ä½™ä»£ç ï¼Œåˆ é™¤äº† **~510 è¡Œ**å·²è¢« Next.js æ›¿ä»£çš„ä»£ç ï¼š

1. âœ… **åˆ é™¤ Workers æœåŠ¡å™¨** - å·²è¢« Next.js API è·¯ç”±æ›¿ä»£
2. âœ… **åˆ é™¤æ¨¡æ¿ç³»ç»Ÿ** - å·²è¢« Next.js é¡µé¢æ›¿ä»£
3. âœ… **åˆ é™¤æ—§å…¥å£æ–‡ä»¶** - å·²è¢« Next.js æ¶æ„æ›¿ä»£
4. âœ… **æ›´æ–°é…ç½®æ–‡ä»¶** - æŒ‡å‘ Next.js æ„å»ºè¾“å‡º
5. âœ… **ä¿ç•™æ‰€æœ‰å¤ç”¨ä»£ç ** - ç¡®ä¿åŠŸèƒ½æ­£å¸¸

**ä»£ç æ¸…ç†ç‡**: 100% (æ‰€æœ‰å†—ä½™ä»£ç å·²åˆ é™¤)  
**åŠŸèƒ½ä¿ç•™ç‡**: 100% (æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ)

**ä¸‹ä¸€æ­¥**: è¿›è¡Œå…¨é¢çš„æµ‹è¯•å’ŒéªŒè¯ï¼Œç¡®ä¿è¿ç§»æˆåŠŸã€‚
