# 核心工作流程 - 文档先行与测试驱动的开发实践

工作流中最重要的是**文档先行**和**测试先行**。因为现在 AI 写代码几乎毫不费力，人类负责把关的就是知道要写什么，和最后写的对不对。借用 ThoughtWork 徐昊的话，软件工程本质上是知识工程，软件是知识的实践和传递。

## 1. 探索-计划阶段

### 1.1 探索阶段

```bash
# 让 Claude 先了解项目结构和业务背景
"请先阅读项目的主要文件，不要立即开始编码"
"我们讨论一下 xxx，这里是背景资料 xxx"
```

### 1.2 计划阶段

```bash
# 生成详细计划
"请制定一个实现用户认证功能的详细计划，使用 think 模式"
"将计划保存到 planning/auth-implementation.md"
```

⚠️ **重要提示**：[CC 明确表示](https://www.anthropic.com/engineering/claude-code-best-practices)，不同的词汇对应不同的模型思考预算：

`"think"` < `"think hard"` < `"think harder"` < `"ultrathink"`

## 2. 测试驱动开发（TDD）

相比让 AI 先写功能再写测试，在项目有条件先写测试再写功能的时候，因为 AI 有一个明确的迭代目标（让测试通过），AI 表现更好，用户也方便验收。

### 2.1 TDD 流程

```bash
# TDD 提示词模板
我们正在进行测试驱动开发（TDD），请你不要创建模拟实现，即使对于还没有实现的功能。
请你根据功能 xxx 和预期输入输出：xxx 编写测试。
你运行测试时将会经历红绿循环。当没有实现或实现有误时，测试红色报错，当实现正确时，测试绿色通过。
不要修改测试。专注实现规划的测试功能。持续迭代，直到所有测试通过。
```

### 2.2 TDD 最佳实践

1. **红绿循环**：先写测试（红），再写实现（绿），最后重构
2. **小步迭代**：每次只实现一个小功能
3. **测试先行**：测试是需求的具体化
4. **重构安全**：有测试保护的重构更安全

## 3. 代码生成最佳实践

### 3.1 明确需求

**对比示例**：

| ❌ 模糊指令 | ✅ 详细指令 |
|-----------|-----------|
| "添加测试" | "为 UserService 的 login 方法添加测试，验证密码错误时抛出 AuthenticationError" |
| "修复 bug" | "修复 Issue #123：用户登出后仍然可以访问受保护页面" |
| "优化性能" | "优化 /api/users 接口，将响应时间从 2s 降低到 500ms 以内" |

### 3.2 精准用词

- `"think"` 代表一般的思考
- `"think more"`、`"think harder"` 代表更多的思考

让 LLM 更多地思考还有很多方法，比如使用 `<think>` 的 COT 和 few-shot，或者使用 sequential-thinking MCP。

## 4. 调试和问题解决

### 4.1 系统化调试

```bash
# 调试流程
1. 复现问题
2. 分析错误日志
3. 定位问题根源
4. 制定修复方案
5. 验证修复效果
6. 添加防护测试
```

### 4.2 调试技巧

- **日志分析**：使用结构化日志记录关键信息
- **断点调试**：在关键位置设置断点
- **单元测试**：编写针对性的单元测试
- **集成测试**：验证组件间的交互

## 5. 重构和优化

### 5.1 重构原则

- **小步重构**：每次只改一个小地方
- **测试保护**：重构前确保有充分的测试覆盖
- **功能不变**：重构不改变外部行为
- **持续集成**：频繁提交，及时发现问题

### 5.2 性能优化

- **性能监控**：建立性能基线和监控
- **瓶颈分析**：使用工具定位性能瓶颈
- **渐进优化**：优先优化影响最大的部分
- **效果验证**：优化后要验证实际效果

## 6. 质量保证

### 6.1 代码审查

- **自动化检查**：使用 lint、格式化工具
- **人工审查**：关注逻辑、设计、安全等
- **AI 辅助**：使用 AI 工具辅助代码审查
- **持续改进**：根据审查结果改进开发流程

### 6.2 测试策略

- **单元测试**：测试单个函数或类
- **集成测试**：测试组件间的交互
- **端到端测试**：测试完整的用户流程
- **性能测试**：验证系统性能指标

## 7. 注意事项

⚠️ **重要提醒**：
- 始终保持代码审查的习惯
- AI 生成的代码也需要人工验证
- 不要过度依赖 AI，保持独立思考
- 定期更新和维护测试用例

通过遵循这些核心工作流程，可以确保在使用 Claude Code 进行开发时既高效又可靠。
